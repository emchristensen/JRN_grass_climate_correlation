---
title: "Grass/PDO model selection"
author: "Erica Christensen"
date: "1/10/2022"
output: html_document
---

```{r setup, include=FALSE}
# last update: 1/10/22

library(dplyr)
library(ggplot2)
library(MuMIn)

# colors for figures
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# read in data
grass = read.csv('data/grass_median_yearly.csv') %>% rename(grass = median_grass)
pptdat = read.csv('data/climate_variables.csv')
pdo_factor = read.csv('data/PDO_phases_byyear.csv')
nino_factor = read.csv('data/ENSO_phases_byyear.csv')

# read in smoothed vars
smoothgrass = read.csv('data/smoothed_grass_gam.csv')
smoothclimate = read.csv('data/smoothed_climate_variables.csv')

# create one big data frame
combined_data = merge(grass, smoothgrass, all=T) %>% 
  merge(pdo_factor, by.x='project_year', by.y='year', all=T) %>%
  merge(nino_factor, by.x='project_year', by.y='year', all=T) %>%
  merge(pptdat, by.x='project_year', by.y='water_yr', all=T) %>%
  merge(smoothclimate, by.x='project_year', by.y='year', all=T) %>%
  rename(year=project_year)

```

## Timeseries cross-correlation

The first thing I did was look at the cross-correlation function between grass and the climate variables. PDO had significant correlation terms going back to lag 10, while Nino 3.4, yearly precip, winter precip, and summer precip had no significant terms.

```{r cars, echo=F}
# cross-correlation functions
corr_data = dplyr::filter(combined_data, !is.na(grass))
acf(corr_data$grass)
ccf(corr_data$pdo, corr_data$grass)
ccf(corr_data$nino34, corr_data$grass)
ccf(corr_data$yearly_ppt, corr_data$grass)
ccf(corr_data$winter_ppt, corr_data$grass)
ccf(corr_data$summer_ppt, corr_data$grass)
```

## Models and model comparison

Linear models were constructed between grass cover (smoothed) and all single climate variables (yearly precip, winter precip, summer precip, PDSI, SPEI, PDO index, Nino 3.4 index, yearly mean temperature), and all smoothed single variables. Smoothed timeseries for each variable were created using GAMs (see GAMs_grass_pdo.R). I also included factor variables of PDO phase (warm/cool) and Nino 3.4 phase (nino/nina/neutral). The predictors best models containing a single climate variable predictor were combined in additional models to see if fit could be improved by including multiple predictors. 

```{r pressure, echo=F}
model_data = combined_data %>%
  dplyr::filter(year>=1916, year<1980)

# models with single predictors
model1 = lm(smoothed_grass ~ pdo, data=model_data)
model1s = lm(smoothed_grass ~ smoothed_pdo, data=model_data)
model2 = lm(smoothed_grass ~ nino34, data=model_data)
model2s = lm(smoothed_grass ~ smoothed_nino, data=model_data)
model3 = lm(smoothed_grass ~ yearly_ppt_mm, data=model_data)
model3s = lm(smoothed_grass ~ smoothed_yearlyppt, data=model_data)
model4 = lm(smoothed_grass ~ winter_ppt_mm, data=model_data)
model4s = lm(smoothed_grass ~ smoothed_winterppt, data=model_data)
model5 = lm(smoothed_grass ~ summer_ppt_mm, data=model_data)
model5s = lm(smoothed_grass ~ smoothed_summerppt, data=model_data)
model6 = lm(smoothed_grass ~ pdsi, data=model_data)
model6s = lm(smoothed_grass ~ smoothed_pdsi, data=model_data)
model7 = lm(smoothed_grass ~ spei, data=model_data)
model7s = lm(smoothed_grass ~ smoothed_spei, data=model_data)
model8 = lm(smoothed_grass ~ mean_temp, data=model_data)
model8s = lm(smoothed_grass ~ smoothed_temp, data=model_data)
model9 = lm(smoothed_grass ~ category_nino34, data=model_data)
model10 = lm(smoothed_grass ~ pdo_phase, data=model_data)

# models with two predictors
model11 = lm(smoothed_grass ~ smoothed_pdo + yearly_ppt_mm, data=model_data)
model12 = lm(smoothed_grass ~ smoothed_pdo + winter_ppt_mm, data=model_data)
model13 = lm(smoothed_grass ~ smoothed_pdo + summer_ppt_mm, data=model_data)
model14 = lm(smoothed_grass ~ smoothed_pdo + nino34, data=model_data)
model15 = lm(smoothed_grass ~ smoothed_pdo + pdsi, data=model_data)
model16 = lm(smoothed_grass ~ smoothed_pdo + spei, data=model_data)
model17 = lm(smoothed_grass ~ smoothed_pdo + mean_temp, data=model_data)
model18 = lm(smoothed_grass ~ smoothed_pdo + category_nino34, data=model_data)

# models with more predictors
model19 = lm(smoothed_grass ~ smoothed_pdo + summer_ppt_mm + nino34, data=model_data)
model20 = lm(smoothed_grass ~ smoothed_pdo + summer_ppt_mm + yearly_ppt_mm, data=model_data)
model21 = lm(smoothed_grass ~ smoothed_pdo + summer_ppt_mm + spei, data=model_data)


# create table with aic and rsquared
modellist = list(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10, model11, model12, model13, model14,
                 model15, model16, model17, model18, model19, model20,model21,
                 model1s, model2s, model3s, model4s, model5s, model6s, model7s, model8s)
aictable = c()
for (m in 1:length(modellist)) {
  model=modellist[[m]]
  aictable = rbind(aictable, data.frame(parameters=paste(names(model$coefficients),collapse=', '),
                                        AICc=AICc(model),
                                        adj.r.squared=summary(model)$adj.r.squared))
}
aictable['deltaAICc'] <- aictable['AICc']-min(aictable['AICc'])

aictable %>% arrange(deltaAICc)

# convert adjusted r squared to percent
aictable$adj.r.squared = aictable$adj.r.squared * 100

write.csv(arrange(aictable, deltaAICc), 'results_aic_table.csv', row.names=F)
```

There are several models almost tied for best AICc. The simplest of these has only smoothed_pdo as a predictor. 

```{r plot model}
# plot results of best model
bestmodel <- model1s

# get coefficient and intercept from best model
coeff <- bestmodel$coefficients[2]
intercept <- bestmodel$coefficients[1]

# plot grass and PDO timeseries on dual axes; derived from best lm
grass_pdo_plot = ggplot(data=model_data, aes(x=year)) +
  geom_line(aes(y=smoothed_grass, color='Grass'), size=1.5) +
  geom_line(aes(y=(smoothed_pdo*coeff)+intercept, color='PDO'), size=1.5) +
  scale_y_continuous(
    name='Grass cover',
    sec.axis = sec_axis(~(.-intercept)/coeff, name='PDO index')
  ) +
  theme_bw() +
  scale_color_manual(name='',values=cbPalette[c(7,3)]) +
  theme(axis.title.y.left = element_text(color=cbPalette[7], face='bold'),
        axis.title.y.right = element_text(color=cbPalette[3], face='bold')) +
  xlab('') 
grass_pdo_plot

ggsave('Figures/grass_pdo_smoothed_GAM.png', plot=grass_pdo_plot, height=3, width=5)
```

## Predictions from model

Using the best model based on the 1916-1979 timeseries, create predictions for grass up to the present. Compare to data collected in 1995, 2001, 2006, 2011, and 2016.


```{r model predict}
# prediction based on best model
newdata = dplyr::filter(combined_data, year>1916) %>%
  dplyr::select(year, smoothed_pdo)
predicted_grass = predict.lm(bestmodel, newdata, interval='prediction') %>% as.data.frame()

modelprediction = data.frame(predicted_grass=predicted_grass$fit,
         lower=predicted_grass$lwr,
         upper=predicted_grass$upr) %>%
  cbind(newdata)


# plot figure
grasspred = ggplot(modelprediction, aes(x=year)) +
  geom_line(aes(y=predicted_grass)) +
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=.3) +
  geom_point(data=combined_data, aes(x=year, y=grass)) +
  xlim(1916, 2020) +
  theme_bw() +
  coord_cartesian(ylim=c(-.005,.1)) +
  xlab('') +
  ylab('Grass cover (m^2)')
grasspred
ggsave('Figures/grass_prediction_from_PDO.png', plot=grasspred, width=5, height=4)
```

