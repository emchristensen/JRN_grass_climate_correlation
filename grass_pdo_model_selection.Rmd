---
title: "Grass/PDO model selection"
author: "Erica Christensen"
date: "5/12/2022"
output: html_document
---

```{r setup, include=FALSE}
# last run: 5/12/22

library(dplyr)
library(ggplot2)
library(MuMIn)
library(astsa)

# colors for figures
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# read in data
grass = read.csv('data/grass_median_yearly.csv') %>% rename(grass = median_grass)
pptdat = read.csv('data/climate_variables.csv')

# create one big data frame
combined_data = grass %>%
  merge(pptdat, by.x='project_year', by.y='water_yr', all=T) %>%
  rename(year=project_year)

# we know from select_variables_for_models.Rmd that a 10-year moving average of PDO should be included in models, and a 1-year lag of pdsi
combined_data = combined_data %>%
  mutate(pdo_mean_10y = c(rep(NA,9),
                      zoo::rollmean(pdo, 10)),
         pdsi_lag1 = lag(pdsi,1))

```


From the variable selection process (in select_variables_for_models.Rmd) we chose PDSI, PDSI lagged 1 year, and a 10-year moving average of the PDO index as candidate predictors for grass cover.  


## Models and model comparison

Linear models were constructed between grass cover the variables identified above.  

```{r linearmodels, echo=F}
model_data = combined_data %>%
  dplyr::filter(year>=1916, year<1980) %>%
  dplyr::select(year, grass, pdo_mean_10y, pdsi, pdsi_lag1, enso_phase)

# models with single predictors
model1 = lm(grass ~ pdo_mean_10y, data=model_data)
model2 = lm(grass ~ pdsi, data=model_data)
model3 = lm(grass ~ pdsi_lag1, data=model_data)
model4 = lm(grass ~ enso_phase, data=model_data)


# models with multiple predictors
model5 = lm(grass ~ pdo_mean_10y + pdsi, data=model_data)
model6 = lm(grass ~ pdo_mean_10y + pdsi_lag1, data=model_data)
model7 = lm(grass ~ pdsi + pdsi_lag1, data=model_data)
model8 = lm(grass ~ pdo_mean_10y + pdsi + pdsi_lag1, data=model_data)

model9 = lm(grass ~ pdo_mean_10y + enso_phase, data=model_data)
model10 = lm(grass ~ pdo_mean_10y + enso_phase + pdsi, data=model_data)
model11 = lm(grass ~ pdo_mean_10y + enso_phase + pdsi_lag1, data=model_data)
model12 = lm(grass ~ pdo_mean_10y + enso_phase + pdsi + pdsi_lag1, data=model_data)

modelnull = lm(grass ~ 1, data=model_data)

# create table with aic and rsquared
modellist = list(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10, model11, model12, modelnull)
                 
aictable = c()
for (m in 1:length(modellist)) {
  model=modellist[[m]]
  aictable = rbind(aictable, data.frame(parameters=paste(names(model$coefficients),collapse=', '),
                                        AICc=AICc(model),
                                        adj.r.squared=summary(model)$adj.r.squared))
}
aictable['deltaAICc'] <- aictable['AICc']-min(aictable['AICc'])

aictable %>% arrange(deltaAICc)

# convert adjusted r squared to percent
aictable$adj.r.squared = aictable$adj.r.squared * 100

write.csv(arrange(aictable, deltaAICc), 'results_aic_table.csv', row.names=F)
```

There are several models almost tied for best AICc. The simplest of these has only 10-year mean of pdo as a predictor. 

```{r plot model, echo=F}

# best model: 5 (smoothed pdo, pdsi_lag1)
# simplest and within 2 AICc units: 1 (just smoothed pdo)

bestmodel = model1

summary(bestmodel)
gratia::appraise(bestmodel)

# x, y plot
scatterplot = ggplot(model_data, aes(x=pdo_mean_10y, y=grass)) +
  geom_point() +
  geom_smooth(method='lm', formula=y~x) +
  xlab('PDO 10-year avg.') +
  ylab('Median Grass Cover (m^2)') +
  theme_bw() 
scatterplot

ggsave('Figures/scatterplot_pdo10y_grass.png', plot=scatterplot, width=4, height=3)

# timeseries plot

newdata = model_data 
predicted_grass = predict.lm(bestmodel, newdata, interval='prediction') %>% as.data.frame()

modelprediction = data.frame(predicted_grass=predicted_grass$fit,
         lower=predicted_grass$lwr,
         upper=predicted_grass$upr) %>%
  cbind(newdata)
timeplot = ggplot(modelprediction, aes(x=year, y=predicted_grass)) +
  geom_line(aes(color = 'Model \nprediction'), size=1.5) +
  geom_point(data=model_data, aes(y=grass, color='Grass \nmeasurement')) +
  scale_color_manual(name='',values=cbPalette[c(7,3)]) +
  xlab('') +
  ylab('Grass Cover (m^2)') +
  theme_bw() 
timeplot

ggsave('Figures/grass_pdo10y_timeseries.png', plot=timeplot, width=5, height=3)
```

## Predict grass 1980-2020 from model

Using the best model based on the 1916-1979 timeseries, create predictions for grass up to 2020. Compare to data collected in 1995, 2001, 2006, 2011, and 2016.


```{r model predict, echo=F}
# prediction based on best model

# plot results of best model


newdata = dplyr::filter(combined_data, year>1915) 
predicted_grass = predict.lm(bestmodel, newdata, interval='prediction') %>% as.data.frame()

modelprediction = data.frame(predicted_grass=predicted_grass$fit,
         lower=predicted_grass$lwr,
         upper=predicted_grass$upr) %>%
  cbind(newdata)


# plot figure
grasspred = ggplot(modelprediction, aes(x=year)) +
  geom_line(aes(y=predicted_grass)) +
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=.3) +
  geom_point(data=combined_data, aes(x=year, y=grass)) +
  xlim(1916, 2022) +
  theme_bw() +
  #coord_cartesian(ylim=c(-.005,.1)) +
  xlab('') +
  ylab('Grass cover (m^2)')
grasspred
ggsave('Figures/grass_prediction_from_PDO.png', plot=grasspred, width=5, height=4)
```

