---
title: "Grass/PDO model selection"
author: "Erica Christensen"
date: "10/8/2021"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(MuMIn)

# load data functions
#source('data_functions.R')
# colors for figures
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# read in data
#grass = read.csv('data/grass_shrub_trends_yearly.csv')
grass = read.csv('data/grass_median_yearly.csv') %>% rename(grass = median_grass)
#pdoindex = read.csv('data/PDO_long_1900_2020.csv')
#soiindex = read.csv('data/SOI_long_1866_2020.csv')
pptdat = read.csv('data/climate_variables.csv')
pdo_factor = read.csv('data/PDO_phases_byyear.csv')
nino_factor = read.csv('data/ENSO_phases_byyear.csv')
#nino34 = read.csv('data/raw_climate_data/Nino34_1870_2020.csv')

# read in smoothed vars
smoothgrass = read.csv('data/smoothed_grass_gam.csv')
smoothpdo = read.csv('data/smoothed_pdo_gam.csv')

# # convert monthly indices to yearly
# pdo_yearly = pdoindex %>% group_by(year) %>%
#   summarize(pdo_year = mean(pdo))
# soi_yearly = soiindex %>% group_by(year) %>%
#   summarise(soi_year=mean(soi))


# # normalize timeseries
# pptdat$pdo_norm = normalize(pdo_yearly$pdo_year)
# soi_yearly$soi_norm = normalize(soi_yearly$soi_year)
# grass$grass_norm = normalize(grass$grass)
# pptdat$yearly_ppt_norm = normalize(pptdat$yearly_ppt_mm)
# pptdat$winter_ppt_norm = c(NA,normalize(pptdat$winter_ppt_mm[-1]))
# pptdat$summer_ppt_norm = normalize(pptdat$summer_ppt_mm)
# nino34$nino34_norm = normalize(nino34$mean)
# 
# # calculate 10-year moving average of pdo
# pdo_10y = moving_avg_10y(pdo_yearly$pdo_year, year=pdo_yearly$year) %>%
#   mutate(pdo_smooth=normalize(index_smooth))
# 
# # calculate moving average of yearly precip
# precip_10y = moving_avg_10y(pptdat$yearly_ppt_mm, year=pptdat$year) %>%
#   mutate(precip_smooth=normalize(index_smooth))
# 
# # moving avg summer and winter precip
# winter_ppt_10y = moving_avg_10y(pptdat$winter_ppt_mm[-1], year=pptdat$year) %>%
#   mutate(winter_ppt_smooth=normalize(index_smooth))
# summer_ppt_10y = moving_avg_10y(pptdat$summer_ppt_mm, year=pptdat$year) %>%
#   mutate(summer_ppt_smooth=normalize(index_smooth))

# create one big data frame
combined_data = merge(grass, smoothgrass, all=T) %>% 
  merge(pdo_factor, by.x='project_year', by.y='year', all=T) %>%
  merge(nino_factor, by.x='project_year', by.y='year', all=T) %>%
  merge(pptdat, by.x='project_year', by.y='water_yr', all=T) %>%
  merge(smoothpdo, by.x='project_year', by.y='year', all=T) %>%
  rename(year=project_year, pdo=pdo.x)%>%
  dplyr::select(-pdo.y, -category_soi)
```

## Timeseries cross-correlation

The first thing I did was look at the ccf between grass (normalized) and the normalized climate variable time series. PDO had significant correlation terms going back to lag 10, while SOI, yearly precip, winter precip, and summer precip had no significant terms.

```{r cars, echo=F}
# cross-correlation functions
corr_data = dplyr::filter(combined_data, !is.na(grass))
acf(corr_data$grass)
ccf(corr_data$pdo, corr_data$grass)
ccf(corr_data$nino34, corr_data$grass)
ccf(corr_data$yearly_ppt, corr_data$grass)
ccf(corr_data$winter_ppt, corr_data$grass)
ccf(corr_data$summer_ppt, corr_data$grass)
```

## Models and model comparison

I created a smoothed PDO variable by calculating 10-year moving window average of the PDO index. I also created a variable indicating PDO phase (cool or warm; factor variable). I compared models correlating normalized grass cover to PDO index, the binary warm/cool pdo phase, 10-year smoothed PDO, SOI, yearly precip, winter precip, and summer precip.

```{r pressure, echo=F}
model_data = combined_data %>%
  dplyr::filter(year>=1916, year<1980)

# models with single predictors
model1 = lm(smoothed_grass ~ pdo, data=model_data)
model2 = lm(smoothed_grass ~ pdo_phase, data=model_data)
model3 = lm(smoothed_grass ~ smoothed_pdo, data=model_data)
model4 = lm(smoothed_grass ~ nino34, data=model_data)
model5 = lm(smoothed_grass ~ yearly_ppt_mm, data=model_data)
model6 = lm(smoothed_grass ~ winter_ppt_mm, data=model_data)
model7 = lm(smoothed_grass ~ summer_ppt_mm, data=model_data)
model8 = lm(smoothed_grass ~ pdsi, data=model_data)
model9 = lm(smoothed_grass ~ spei, data=model_data)
model10 = lm(smoothed_grass ~ mean_temp, data=model_data)
model11 = lm(smoothed_grass ~ category_nino34, data=model_data)

# models with two predictors
model12 = lm(smoothed_grass ~ smoothed_pdo + yearly_ppt_mm, data=model_data)
model13 = lm(smoothed_grass ~ smoothed_pdo + winter_ppt_mm, data=model_data)
model14 = lm(smoothed_grass ~ smoothed_pdo + summer_ppt_mm, data=model_data)
model15 = lm(smoothed_grass ~ smoothed_pdo + nino34, data=model_data)
model16 = lm(smoothed_grass ~ smoothed_pdo + pdsi, data=model_data)
model17 = lm(smoothed_grass ~ smoothed_pdo + spei, data=model_data)
model18 = lm(smoothed_grass ~ smoothed_pdo + mean_temp, data=model_data)

# models with more predictors
model19 = lm(smoothed_grass ~ smoothed_pdo + summer_ppt_mm + nino34, data=model_data)
model20 = lm(smoothed_grass ~ smoothed_pdo + summer_ppt_mm + yearly_ppt_mm, data=model_data)
model21 = lm(smoothed_grass ~ smoothed_pdo + summer_ppt_mm + spei, data=model_data)


# create table with aic and rsquared
modellist = list(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10, model11, model12, model13, model14,
                 model15, model16, model17, model18, model19, model20, model21)
aictable = c()
for (m in 1:length(modellist)) {
  model=modellist[[m]]
  aictable = rbind(aictable, data.frame(parameters=paste(names(model$coefficients),collapse=', '),
                                        AICc=AICc(model),
                                        adj.r.squared=summary(model)$adj.r.squared))
}
aictable['deltaAICc'] <- aictable['AICc']-min(aictable['AICc'])
#aictable['weightedAIC'] <- round(exp(-0.5 * aictable['deltaAICc'])/sum(exp(-0.5 * aictable['deltaAICc'])),4)
aictable %>% arrange(deltaAICc)

write.csv(arrange(aictable, deltaAICc), 'results_aic_table.csv', row.names=F)
```

There are several models almost tied for best AICc. The simplest of these has only pdo_smooth as a predictor. 

```{r plot model}
# plot results of best model
bestmodel <- model3

#coeff <- 0.04319
coeff <- bestmodel$coefficients[2]
#intercept <- 0.039939
intercept <- bestmodel$coefficients[1]

grass_pdo_plot = ggplot(data=model_data, aes(x=year)) +
  geom_line(aes(y=smoothed_grass, color='Grass'), size=1.5) +
  geom_line(aes(y=(smoothed_pdo*coeff)+intercept, color='PDO'), size=1.5) +
  scale_y_continuous(
    name='Grass cover',
    sec.axis = sec_axis(~(.-intercept)/coeff, name='PDO index')
  ) +
  theme_bw() +
  scale_color_manual(name='',values=cbPalette[c(7,3)]) +
  theme(axis.title.y.left = element_text(color=cbPalette[7], face='bold'),
        axis.title.y.right = element_text(color=cbPalette[3], face='bold')) +
  xlab('') 
grass_pdo_plot

#ggsave('Figures/grass_pdo_smoothed_GAM.png', plot=grass_pdo_plot, height=3, width=5)
```

## Predictions from model

```{r model predict}
# prediction based on best model
newdata = dplyr::filter(combined_data, year>1916) %>%
  dplyr::select(year, smoothed_pdo)
predicted_grass = predict.lm(bestmodel, newdata, interval='prediction') %>% as.data.frame()

modelprediction = data.frame(predicted_grass=predicted_grass$fit,
         lower=predicted_grass$lwr,
         upper=predicted_grass$upr) %>%
  cbind(newdata)

#se = 0.003569 # from summary(model3): std. error of fitted_pdo
# plot figure
grasspred = ggplot(modelprediction, aes(x=year)) +
  geom_line(aes(y=predicted_grass)) +
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=.3) +
  geom_point(data=combined_data, aes(x=year, y=grass)) +
  xlim(1916, 2020) +
  theme_bw() +
  coord_cartesian(ylim=c(0,.1)) +
  xlab('') +
  ylab('Grass cover (m^2)')
grasspred
ggsave('Figures/grass_prediction_from_PDO.png', plot=grasspred, width=5, height=4)
```

